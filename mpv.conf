# =================================================================================================
# General Settings
# =================================================================================================
profile=high-quality
vo=gpu-next                            # Modern renderer, recommended for HDR and new features
gpu-api=vulkan                         # Vulkan performs best under gpu-next; fallback to d3d11 (Windows) or opengl if bugs occur
fullscreen=yes
keep-open=always
reset-on-next-file=pause
save-position-on-quit=yes
auto-window-resize=yes
taskbar-progress=no
force-seekable=yes
hr-seek=yes                            # Allow precise frame-by-frame seeking, even for non-keyframes

# =================================================================================================
# Video & Quality
# =================================================================================================
hwdec=auto-safe                        # Optimization: Changed from 'no' to 'auto-safe' to use hardware decoding where possible without quality loss
dither-depth=auto

# Scaling Algorithms
# ewa_lanczossharp can cause ringing; using more balanced ewa_lanczos or spline36
scale=ewa_lanczos
scale-antiring=0.6
# Chroma upscaling/downscaling: Overridden when CfL shaders are active, but as a fallback, catmull_rom is more efficient than ewa_lanczossharp
cscale=catmull_rom
dscale=mitchell

# Debanding - Disabled by default, enabled dynamically by Profiles
deband=no
deband-iterations=2
deband-threshold=48                    # Too high might erase details
deband-range=16
deband-grain=32                        # Increase grain to mask banding

# Cache and Shader Cache
gpu-shader-cache-dir='~~/shaders/cache'
demuxer-max-bytes=2048MiB
demuxer-readahead-secs=300

# =================================================================================================
# Interpolation / Motion
# =================================================================================================
video-sync=display-resample            # Must be enabled for interpolation
interpolation=yes
tscale=mitchell

# =================================================================================================
# OSD / Interface
# =================================================================================================
osc=no                                 # Disabled built-in OSC
border=no

osd-bar=no
cursor-autohide-fs-only=yes
cursor-autohide=1000
osd-level=1
osd-duration=2000
osd-font='Verdana'
osd-font-size=24                       # Fine-tune size
osd-color='#FFFFFF'
osd-border-color='#000000'
osd-border-size=1.2                    # Slightly thicken border for readability on bright backgrounds
osd-blur=0.2

# =================================================================================================
# Audio & Subtitles
# =================================================================================================
alang=ja,jp,jpn,en,eng,zh,cmn,chi
slang=zh,cmn,chi,zh-CN,sc,chs,en,eng
volume=100
volume-max=150                         # Too high will cause clipping
audio-channels=auto-safe               # Optimization: Changed from 'stereo' to 'auto-safe' to avoid losing information from multi-channel sources
audio-pitch-correction=yes
sub-auto=fuzzy
sub-font='Netflix Sans Medium'
sub-font-size=45
sub-border-size=2.0
sub-shadow-offset=1                    # Add some shadow for depth
blend-subtitles=yes

# =================================================================================================
# Screenshots
# =================================================================================================
screenshot-format=png
screenshot-high-bit-depth=yes
screenshot-png-compression=4           # Compression ratio affects file size
screenshot-directory="~/tmp/mpv-screenshots"
screenshot-template="%f-%wH.%wM.%wS.%wT-#%#00n"

# =================================================================================================
# Protocols
# =================================================================================================
[protocol.http]
hls-bitrate=max
cache=yes
no-cache-pause

[protocol.https]
profile=protocol.http

[protocol.ytdl]
profile=protocol.http

# =================================================================================================
# Profiles
# =================================================================================================

[WEB-DL]
profile-desc=WEB-DL Anime
profile-cond=string.match(p.filename, "HatSubs")~=nil or string.match(p.filename, "SubsPlease")~=nil or string.match(p.filename, "HorribleSubs")~=nil or string.match(p.filename, "Erai%-raws")~=nil
deband=yes

[hdr-direct]
profile-desc=HDR Passthrough/Tone mapping
profile-cond=p["video-params/sig-peak"]>1 and p["video-params/gamma"]=="pq"
profile-restore=copy
target-peak=auto                       # 'auto' usually works better than a fixed 1000nit under gpu-next
tone-mapping=spline                    # Recommended tone mapping algorithm
target-contrast=auto                   # Unless using OLED in a pitch-black room, 'auto' is better than 'inf'
target-colorspace-hint=yes

# --- Resolution & Frame Rate Detection ---
# 1. Luma super-resolution upscaling
# 2. Chroma repair/upscaling
# 3. Debanding & Denoising

[4k60]
profile-desc=4k60
profile-cond=((width ==3840 and height ==2160) and p["estimated-vf-fps"]>=31)
deband=no
interpolation=no
# 4K sources usually don't need Luma upscaling, only Chroma processing
glsl-shader="~~/shaders/CfL_Prediction.glsl"

[4k30]
profile-desc=4k30
profile-cond=((width ==3840 and height ==2160) and p["estimated-vf-fps"]<31)
deband=no
# Global interpolation is already enabled, no need to disable here
glsl-shader="~~/shaders/CfL_Prediction.glsl"

[full-hd60]
profile-desc=full-hd60
profile-cond=((width ==1920 and height ==1080) and not p["video-frame-info/interlaced"] and p["estimated-vf-fps"]>=31)
interpolation=no
deband=yes                             # 1080p sources usually have banding, recommended to enable
glsl-shader="~~/shaders/ArtCNN_C4F16.glsl"
glsl-shader="~~/shaders/CfL_Prediction.glsl"

[full-hd30]
profile-desc=full-hd30
profile-cond=((width ==1920 and height ==1080) and not p["video-frame-info/interlaced"] and p["estimated-vf-fps"]<31)
deband=yes
glsl-shader="~~/shaders/ArtCNN_C4F16.glsl"
glsl-shader="~~/shaders/CfL_Prediction.glsl"

[full-hd-interlaced]
profile-desc=full-hd-interlaced
profile-cond=((width ==1920 and height ==1080) and p["video-frame-info/interlaced"] and p["estimated-vf-fps"]<31)
deinterlace=yes
deband=yes
glsl-shader="~~/shaders/ArtCNN_C4F16.glsl"
glsl-shader="~~/shaders/CfL_Prediction.glsl"

[hd]
profile-desc=hd-720p
profile-cond=(width ==1280 and height ==720)
interpolation=no
deband=yes
glsl-shader="~~/shaders/ravu-zoom-ar-r3.hook"
glsl-shader="~~/shaders/CfL_Prediction.glsl"

[sdtv-ntsc]
profile-desc=sdtv-ntsc
profile-cond=((width ==640 and height ==480) or (width ==704 and height ==480) or (width ==720 and height ==480))
deinterlace=yes
deband=yes
glsl-shader="~~/shaders/ravu-zoom-ar-r3.hook"
glsl-shader="~~/shaders/CfL_Prediction.glsl"

[sdtv-pal]
profile-desc=sdtv-pal
profile-cond=((width ==352 and height ==576) or (width ==480 and height ==576) or (width ==544 and height ==576) or (width ==720 and height ==576))
deinterlace=yes
deband=yes
glsl-shader="~~/shaders/ravu-zoom-ar-r3.hook"
glsl-shader="~~/shaders/CfL_Prediction.glsl"

[Manga]
profile-desc="Read Manga"
profile-cond=filename and (filename:match('%.cbz$') or filename:match('%.cbr$') or filename:match('%.zip$') or filename:match('%.rar$'))
profile=high-quality
dscale=mitchell
deband=no
